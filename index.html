<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VCE Examination Service</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<style>
  * {
    padding: 0;
    margin: 0;
    font-family: Verdana;
  }

  .start {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    padding: 30px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    text-align: center;
    font-family: Arial, sans-serif;
  }

  .start h1 {
    margin-bottom: 15px;
    font-size: 24px;
    color: #333;
  }

  .start p {
    margin-bottom: 20px;
    color: #666;
    font-size: 16px;
  }

  .start input,
  .start select {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    outline: none;
    transition: border 0.3s;
    margin-bottom: 20px;
    box-sizing: border-box;
  }

  .start input:focus,
  .start select:focus {
    border-color: #007bff;
  }

  .start button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
  }

  .start button:hover {
    background: #0056b3;
    transform: translateY(-2px);
  }

  .start button:active {
    background: #00408f;
    transform: translateY(0);
  }

  .exam {
    display: grid;
    grid-template-rows: 70px 1fr;
    grid-template-columns: 220px 1fr 250px;
    height: 100vh;
    width: 100vw;
    background: #f7f9fc;
    display: none;
    font-family: Verdana, Arial, sans-serif;
  }

  header {
    grid-column: 1 / 4;
    background: #0056b3;
    color: white;
    font-size: 1.8em;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    letter-spacing: 1px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
  }

  .sidebar {
    background: #fff;
    border-right: 1px solid #ddd;
    padding: 15px;
    overflow-y: auto;
  }

  .sidebar h3 {
    margin-bottom: 10px;
    font-size: 1.2em;
    color: #333;
  }

  .number {
    width: 40px;
    height: 40px;
    margin: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #e4e7eb;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
  }

  .number:hover {
    background: #007bff;
    color: #fff;
  }

  .questions {
    padding: 30px;
  }

  .question-card {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .question-card h2 {
    margin-bottom: 20px;
    font-size: 1.4em;
    color: #222;
  }

  .option {
    display: block;
    margin: 10px 0;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .option:hover {
    background: #f0f4ff;
    border-color: #007bff;
  }

  .rightpanel {
    background: #fff;
    border-left: 1px solid #ddd;
    padding: 20px;
  }

  .rightpanel h3 {
    margin-bottom: 15px;
    color: #333;
  }

  .submit-btn {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 8px;
    margin-top: 20px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .submit-btn:hover {
    background: #0056b3;
  }

  .nav-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    padding: 0 30px;
  }

  .nav-btn {
    padding: 12px 28px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
  }

  .prev-btn {
    background: #6c757d;
    color: white;
  }

  .prev-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
  }

  .next-btn {
    background: #28a745;
    color: white;
  }

  .next-btn:hover {
    background: #218838;
    transform: translateY(-2px);
  }

  .success-page {
    min-height: 100vh;
    width: 100%;
    display: none;
    background: #f8fafc;
    color: #1e293b;
    overflow-y: auto;
    flex-direction: column;
  }

  .results-hero {
    background: white;
    padding: 60px 20px;
    text-align: center;
    border-bottom: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .results-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 40px 20px;
    width: 100%;
    box-sizing: border-box;
  }

  .score-visual-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 60px;
    flex-wrap: wrap;
    margin-bottom: 40px;
  }

  .score-circle-wrapper {
    position: relative;
    width: 220px;
    height: 220px;
  }

  .circular-progress {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    background: conic-gradient(#3b82f6 0deg, #f1f5f9 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .circular-progress::before {
    content: "";
    position: absolute;
    width: 180px;
    height: 180px;
    background: white;
    border-radius: 50%;
  }

  .progress-value {
    position: relative;
    font-size: 48px;
    font-weight: 800;
    color: #1e293b;
  }

  .score-details {
    text-align: left;
  }

  .remark-text {
    font-size: 36px;
    font-weight: 800;
    margin-bottom: 8px;
  }

  .score-stats {
    font-size: 18px;
    color: #64748b;
    margin-bottom: 24px;
  }

  .exit-btn {
    background: #1e293b;
    color: white;
    border: none;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .exit-btn:hover {
    background: #334155;
    transform: translateY(-2px);
  }

  .review-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 40px;
  }

  .review-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s;
  }

  .review-card:hover {
    transform: translateX(4px);
  }

  .review-card.correct {
    border-left: 6px solid #10b981;
  }

  .review-card.incorrect {
    border-left: 6px solid #ef4444;
  }

  .question-text {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .answer-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .ans-box {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 15px;
  }

  .ans-box label {
    display: block;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 4px;
    color: #64748b;
  }

  .ans-box.user {
    background: #f8fafc;
  }

  .ans-box.correct {
    background: #f0fdf4;
    color: #166534;
  }

  .ans-box.wrong {
    background: #fef2f2;
    color: #991b1b;
  }

  @media (max-width: 640px) {
    .score-visual-row {
      flex-direction: column;
      gap: 30px;
    }

    .score-details {
      text-align: center;
    }

    .answer-comparison {
      grid-template-columns: 1fr;
    }
  }
</style>

<body>
  <div id="start" class="start">
    <h1>VCE Examination Portal</h1>
    <p>Select Branch and Enter Roll Number</p>
    <select id="branch-select">
      <option value="">Select Branch</option>
      <option value="main">Main Branch</option>
      <option value="second">Second Branch</option>
      <option value="third">Third Branch</option>
    </select>
    <input id="roll-input" type="text" placeholder="Roll Number" />
    <input id="exam-id-input" type="text" placeholder="Exam ID" value="101:MS" readonly />
    <button id="start-exam">Start Exam</button>
  </div>

  <div id="exam" class="exam">
    <header>
      <p id="timer">‚è≥ 30:00</p>
    </header>

    <div class="sidebar">
      <h3>Questions</h3>
    </div>

    <div class="questions">
      <div class="question-card">
        <!-- Question content goes here -->
      </div>
      <div class="nav-buttons">
        <button class="nav-btn prev-btn">‚¨Ö Previous</button>
        <button class="nav-btn next-btn">Next ‚û°</button>
      </div>
    </div>

    <div class="rightpanel">
      <div id="candidate-info">
        <h3>Candidate Info</h3>
        <p><b>Name:</b> Loading...</p>
        <p><b>Roll No:</b> Loading...</p>
        <p><b>Status:</b> Active</p>
      </div>
      <button class="submit-btn">Submit Exam</button>
    </div>
  </div>

  <div id="success" class="success-page">
    <!-- Full page results will be injected here -->
  </div>

  <script>
    const SUPABASE_URL = 'https://pgvwjskubfonmirtaodo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndndqc2t1YmZvbm1pcnRhb2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MjY2OTUsImV4cCI6MjA3NTQwMjY5NX0.dTHvwiH_UZC7K8pxLYIt5VOstu-4Shy0DW3n3C8TJsg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allQuestions = [];
    let currentIndex = 0;
    let userAnswers = [];
    let currentUser = null;
    let currentExamId = "";
    let examSubmitted = false;

    function toTitleCase(str) {
      if (!str) return "";
      return str.replace(/\w\S*/g, function (txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }

    document.getElementById("start-exam").addEventListener("click", async () => {
      const startBtn = document.getElementById("start-exam");
      const branchSelect = document.getElementById("branch-select");
      const rollInput = document.getElementById("roll-input");
      const examIdInput = document.getElementById("exam-id-input");

      const branch = branchSelect.value;
      const roll = rollInput.value.trim();
      const examId = examIdInput.value.trim();

      if (!branch || !roll) {
        alert("Please select branch and enter roll number");
        return;
      }

      const formattedId = `${branch.charAt(0).toLowerCase()}_${roll}`;
      console.log(formattedId);
      const originalText = startBtn.textContent;
      startBtn.disabled = true;
      startBtn.textContent = "Verifying...";
      startBtn.style.background = "grey";

      try {
        const { data: student, error } = await supabaseClient
          .from('students')
          .select('*')
          .eq('roll_number', formattedId)
          .single();

        if (error || !student) {
          alert("Roll number not found. Please check your details.");
          startBtn.disabled = false;
          startBtn.textContent = originalText;
          startBtn.style.background = "#007bff";
          return;
        }

        // Student found
        currentUser = student;
        currentExamId = examId;

        // Update Right Panel
        const candidateInfo = document.getElementById("candidate-info");
        candidateInfo.innerHTML = `
      <h3>Candidate Info</h3>
      <p><b>Roll Number:</b> ${student.roll_number}</p>
      <p><b>Student Name:</b> ${toTitleCase(student.student_name)}</p>
      <p><b>Father Name:</b> ${toTitleCase(student.father_name)}</p>
      <p><b>Course:</b> ${toTitleCase(student.course)}</p>
      <p><b>Batch Time:</b> ${toTitleCase(student.batch_time)}</p>
      <p><b>Exam ID:</b> ${currentExamId || 'N/A'}</p>
      <p><b>Status:</b> Active</p>
    `;

        // Proceed to Exam
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(() => { });
        }

        document.getElementById("start").style.display = "none";
        document.getElementById("exam").style.display = "grid";

        startTimer(30);
        await loadAllQuestions();
        renderQuestion(0);

      } catch (err) {
        console.error("Verification error:", err);
        alert("Something went wrong. Please try again.");
        startBtn.disabled = false;
        startBtn.textContent = originalText;
        startBtn.style.background = "#007bff";
      }
    });

    async function loadAllQuestions() {
      try {
        const res = await fetch("computers.json");
        const data = await res.json();

        // Select 20 random questions
        allQuestions = data.sort(() => Math.random() - 0.5).slice(0, 20);
        renderSidebar();
      } catch (err) {
        console.error("Error loading questions:", err);
      }
    }

    function renderSidebar() {
      const sidebar = document.querySelector(".sidebar");
      sidebar.innerHTML = "<h3>Questions</h3>";
      allQuestions.forEach((_, idx) => {
        const numDiv = document.createElement("div");
        numDiv.className = "number";
        numDiv.textContent = idx + 1;
        numDiv.addEventListener("click", () => renderQuestion(idx));
        sidebar.appendChild(numDiv);
      });
      updateSidebarHighlight();
    }

    function renderQuestion(index) {
      currentIndex = index;
      const qDiv = document.querySelector(".questions");
      const q = allQuestions[index];
      const isLast = index === allQuestions.length - 1;

      qDiv.innerHTML = `
    <div class="question-card">
      <h2>Q${index + 1}. ${q.question_en}</h2>
      <h3 style="color:#555; font-weight:normal; margin-top:10px;">${q.question_hi || ""}</h3>
      ${q.options_en.map((opt, i) => `
        <label class="option">
          <input type="radio" name="q${index}" value="${opt}">
          ${(q.options_hi && q.options_hi[i]) || opt} (${opt})
        </label>`).join('')}
    </div>
    <div class="nav-buttons">
      <button class="nav-btn prev-btn" ${index === 0 ? "disabled" : ""}>‚¨Ö Previous</button>
      ${isLast
          ? '<button class="nav-btn submit-btn-final">Submit Exam</button>'
          : '<button class="nav-btn next-btn">Next ‚û°</button>'}
    </div>
  `;

      // Restore answer
      if (userAnswers[index]) {
        const radio = qDiv.querySelector(`input[value="${userAnswers[index]}"]`);
        if (radio) radio.checked = true;
      }

      // Event listeners
      qDiv.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener("change", () => {
          userAnswers[index] = input.value;
        });
      });

      qDiv.querySelector(".prev-btn").addEventListener("click", () => renderQuestion(currentIndex - 1));
      if (!isLast) {
        qDiv.querySelector(".next-btn").addEventListener("click", () => renderQuestion(currentIndex + 1));
      } else {
        qDiv.querySelector(".submit-btn-final").addEventListener("click", submitExam);
      }

      updateSidebarHighlight();
    }

    function updateSidebarHighlight() {
      const numbers = document.querySelectorAll(".number");
      numbers.forEach((num, idx) => {
        num.style.background = idx === currentIndex ? "#007bff" : "#e4e7eb";
        num.style.color = idx === currentIndex ? "#fff" : "#000";
      });
    }

    function startTimer(durationInMinutes) {
      let time = durationInMinutes * 60;
      const timerDisplay = document.getElementById("timer");

      const interval = setInterval(() => {
        const mins = Math.floor(time / 60);
        const secs = time % 60;
        timerDisplay.textContent = `‚è≥ ${mins}:${secs < 10 ? "0" : ""}${secs}`;

        if (time <= 0) {
          clearInterval(interval);
          submitExam();
        }
        time--;
      }, 1000);
    }

    function calculateScore() {
      let score = 0;
      allQuestions.forEach((q, i) => {
        if (userAnswers[i] && userAnswers[i].trim().toLowerCase() === q.answer_en.trim().toLowerCase()) {
          score++;
        }
      });
      return score;
    }

    async function submitExam() {
      if (examSubmitted) return;
      examSubmitted = true;

      const score = calculateScore();

      // Update submit buttons
      document.querySelectorAll(".submit-btn, .submit-btn-final").forEach(btn => {
        btn.disabled = true;
        btn.textContent = "Submitting...";
        btn.style.background = "grey";
      });

      // Calculate score and render dashboard immediately for UI
      renderResultsDashboard(score);

      try {
        // Record exam result in Supabase
        await supabaseClient.from('exam_result').insert([
          {
            exam_id: currentExamId,
            roll_number: currentUser.roll_number,
            student_name: currentUser.student_name,
            student_score: score,
            father_name: currentUser.father_name
          }
        ]);
      } catch (err) {
        console.error("Submission error:", err);
      }

      document.getElementById("exam").style.display = "none";
      document.getElementById("success").style.display = "flex";

      // Optional: Auto-reload after longer delay to let them see results
      // setTimeout(() => location.reload(), 30000); 
    }

    function renderResultsDashboard(score) {
      const container = document.getElementById("success");
      const percentage = (score / allQuestions.length) * 100;

      let remark = "";
      let remarkColor = "";
      if (percentage === 100) { remark = "Perfect! ‚öñÔ∏è"; remarkColor = "#10b981"; }
      else if (percentage >= 80) { remark = "Excellent Work! üåü"; remarkColor = "#3b82f6"; }
      else if (percentage >= 60) { remark = "Good Effort! üëç"; remarkColor = "#f59e0b"; }
      else { remark = "Need Hardwork! üí™"; remarkColor = "#ef4444"; }

      let reviewCards = allQuestions.map((q, i) => {
        const isCorrect = userAnswers[i]?.trim().toLowerCase() === q.answer_en.trim().toLowerCase();
        const userAns = userAnswers[i] || "Not Answered";
        const correctAns = q.answer_en;

        let userAnsHi = "";
        if (userAnswers[i]) {
          const idx = q.options_en.indexOf(userAns);
          userAnsHi = idx !== -1 ? q.options_hi[idx] : "";
        }

        const correctIdx = q.options_en.indexOf(correctAns);
        const correctAnsHi = correctIdx !== -1 ? q.options_hi[correctIdx] : "";

        return `
      <div class="review-card ${isCorrect ? 'correct' : 'incorrect'}">
        <div class="question-text">${i + 1}. ${q.question_en}</div>
        <div class="question-text-hi" style="color: #64748b; font-size: 16px; margin-top: -12px; margin-bottom: 20px; font-weight: 500; font-family: Arial, sans-serif;">${q.question_hi || ""}</div>
        <div class="answer-comparison">
          <div class="ans-box user ${isCorrect ? 'correct' : 'wrong'}">
            <label>Your Answer</label>
            <div style="font-weight: 700;">${userAns}</div>
            <div style="font-size: 13px; margin-top: 4px; opacity: 0.8;">${userAnsHi}</div>
          </div>
          <div class="ans-box correct">
            <label>Correct Answer</label>
            <div style="font-weight: 700;">${correctAns}</div>
            <div style="font-size: 13px; margin-top: 4px; opacity: 0.8;">${correctAnsHi}</div>
          </div>
        </div>
      </div>
    `;
      }).join('');

      container.innerHTML = `
    <div class="results-hero">
      <div class="score-visual-row">
        <div class="score-circle-wrapper">
          <div class="circular-progress" id="progress-circle">
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="score-details">
          <div class="remark-text" style="color: ${remarkColor}">${remark}</div>
          <div class="score-stats">
            You got <strong>${score}</strong> out of <strong>${allQuestions.length}</strong> questions correct.
          </div>
          <button class="exit-btn" onclick="location.reload()">Back to Home</button>
        </div>
      </div>
    </div>

    <div class="results-content">
      <h3 style="margin-bottom: 24px; font-weight: 800; font-size: 24px;">Question Review</h3>
      <div class="review-grid">
        ${reviewCards}
      </div>
      <div style="text-align: center; margin-top: 60px;">
        <button class="exit-btn" style="background:#64748b" onclick="location.reload()">Finish & Close</button>
      </div>
    </div>
  `;

      // Animate the circle
      let startValue = 0;
      const progressCircle = document.getElementById("progress-circle");
      const progressValue = progressCircle.querySelector(".progress-value");

      if (percentage === 0) {
        progressCircle.style.background = `conic-gradient(#f1f5f9 360deg, #f1f5f9 0deg)`;
        progressValue.textContent = `0%`;
        return;
      }

      let interval = 20;
      let progress = setInterval(() => {
        startValue++;
        progressValue.textContent = `${startValue}%`;
        progressCircle.style.background = `conic-gradient(${remarkColor} ${startValue * 3.6}deg, #f1f5f9 0deg)`;

        if (startValue == Math.round(percentage)) {
          clearInterval(progress);
        }
      }, interval);
    }

    // Global submit button handler
    document.querySelector(".submit-btn").addEventListener("click", submitExam);
  </script>
</body>

</html>